# DeFi Pokémon Project Documentation

**Version:** 1.0.0
**Date:** May 8, 2025

### Table of Contents

1.  [Project Overview](#project-overview)
2.  [Getting Started](#getting-started-1)
3.  [Directory Structure](#directory-structure)
4.  [Smart Contracts (`contracts/`)](#smart-contracts-contracts)
    *   [PokemonNFT.sol](#pokemonnftsol)
5.  [Frontend (`frontend/`)](#frontend-frontend)
    *   [Core Files](#core-files)
    *   [Routes (`src/routes/`)](#routes-srcroutes)
    *   [Library (`src/lib/`)](#library-srclib)
6.  [Scripts (`scripts/`)](#scripts-scripts)
    *   [deploy.js](#deployjs)
7.  [Tests (`test/`)](#tests-test)
    *   [Lock.js](#lockjs)
8.  [Root Configuration Files](#root-configuration-files)

---

### 1. Project Overview

The DeFi Pokémon project is a decentralized application (dApp) that allows users to mint, own, trade, and auction Pokémon as Non-Fungible Tokens (NFTs) on an Ethereum-based blockchain. It combines blockchain technology for asset ownership and trading with a web interface for user interaction.

**Key Technologies:**

*   **Smart Contracts:** Solidity, Hardhat, OpenZeppelin Contracts
*   **Frontend:** SvelteKit, TypeScript, Ethers.js, TailwindCSS
*   **Blockchain Interaction:** MetaMask

---

### 2. Getting Started

(This section is based on your existing `README.md` and project structure)

1.  **Prerequisites:**
    *   Node.js and npm (or yarn/pnpm)
    *   MetaMask browser extension
2.  **Installation:**
    *   Clone the repository.
    *   Install root dependencies: `npm install`
    *   Install frontend dependencies: `cd frontend && npm install`
3.  **Configuration:**
    *   Navigate back to the root directory: `cd ..`
    *   Copy the run script template: `cp run.template.sh run.sh`
    *   Make the script executable: `chmod +x run.sh`
    *   Edit `run.sh` and set your `SEED_PHRASE` for the Hardhat local network. This will be used to generate deterministic addresses for testing.
        ```bash
        // filepath: ./defi_pokemon/run.sh
        export SEED_PHRASE="your twelve word seed phrase here"
        # ... rest of the script
        ```
4.  **Running the Application:**
    *   Execute the run script: `./run.sh`
    *   This script will:
        1.  Start a local Hardhat blockchain node.
        2.  Deploy the `PokemonNFT` smart contract to the local node.
        3.  Copy the contract ABI and address to the frontend.
        4.  Start the SvelteKit frontend development server (usually on `http://localhost:5173`).
        5.  When you stop the script (e.g., with Ctrl+C), it will attempt to stop the Hardhat node.
6. Running the Test Suite
    * Run `export SEED_PHRASE='...' npx harthat test`
---

### 3. Directory Structure

```
.
├── artifacts/            # Compiled smart contracts and ABIs (generated by Hardhat)
├── contracts/            # Solidity smart contracts
│   └── PokemonNFT.sol
├── frontend/             # SvelteKit frontend application
│   ├── src/
│   │   ├── lib/          # Frontend libraries, components, and contract interaction logic
│   │   │   ├── contracts-config.json # Deployed contract address and ABI
│   │   │   ├── nft.ts    # NFT interaction logic
│   │   │   └── pokemons.json # Pokémon metadata
│   │   ├── routes/       # SvelteKit page routes
│   │   └── app.html      # Main HTML shell
│   ├── static/           # Static assets
│   ├── svelte.config.js  # SvelteKit configuration
│   └── vite.config.ts    # Vite configuration
├── scripts/              # Deployment and utility scripts
│   └── deploy.js
├── test/                 # Smart contract tests
│   └── Lock.js
├── .env.example          # Environment variable template (if any, not present in current view)
├── hardhat.config.js     # Hardhat configuration
├── package.json
├── README.md
└── run.template.sh       # Template script to run the project
```

---

### 4. Smart Contracts (`contracts/`)

#### `PokemonNFT.sol`

This is the core smart contract for the DeFi Pokémon application. It implements an ERC721 token, representing each Pokémon as a unique NFT. It also includes functionalities for a marketplace, allowing fixed-price sales and auctions.

*   **Inherits:** `ERC721` (OpenZeppelin), `Ownable` (OpenZeppelin), `ReentrancyGuard` (OpenZeppelin)
*   **Key Features:**
    *   Minting new Pokémon NFTs (restricted to contract owner).
    *   Storing Pokémon metadata (base index, level).
    *   Transferring Pokémon between users.
    *   Listing Pokémon for fixed-price sales.
    *   Buying Pokémon listed for fixed-price.
    *   Starting and managing auctions for Pokémon.
    *   Placing bids in auctions.
    *   Ending auctions and transferring NFTs/funds accordingly.

*   **Structs:**
    *   `Pokemon`: Stores `baseIdx` (index in `pokemons.json`) and `level`.
    *   `Auction`: Stores details for an auction, including `seller`, `tokenId`, `startingPrice`, `highestBid`, `highestBidder`, `endTime`, and `ended` status.

*   **Mappings:**
    *   `_pokemonData`: `tokenId` => `Pokemon` (stores details for each NFT).
    *   `_listings`: `tokenId` => `price` (stores fixed sale price for listed NFTs).
    *   `_auctions`: `tokenId` => `Auction` (stores auction details for NFTs up for auction).

*   **Events:**
    *   `PokemonListed(uint256 indexed tokenId, uint256 price, address indexed seller)`: Emitted when a Pokémon is listed for fixed-price sale.
    *   `PokemonSold(uint256 indexed tokenId, uint256 price, address indexed buyer)`: Emitted when a Pokémon is bought.
    *   `AuctionStarted(uint256 indexed tokenId)`: Emitted when an auction for a Pokémon starts.
    *   `NewBid(uint256 indexed tokenId, address indexed bidder, uint256 amount)`: Emitted when a new bid is placed in an auction.
    *   `AuctionEnded(uint256 indexed tokenId, address indexed winner, uint256 amount)`: Emitted when an auction ends.

*   **Key Functions:**
    *   `constructor(uint256 maxId_)`: Initializes the NFT with name "PokemonNFT", symbol "PKMN", and sets the maximum base ID for Pokémon.
    *   `mintPokemon(address player, uint256 baseIdx, uint256 level)`: (Owner only) Mints a new Pokémon NFT and assigns it to `player`.
    *   `getPokemonDetails(uint256 tokenId)`: Returns `baseIdx`, `level`, `price` (listing price/auction starting price), `highestBid` (in auction), and `isAuction` status.
    *   `getOwner(uint256 tokenId)`: Returns the owner of the specified `tokenId`.
    *   `transferPokemon(address to, uint256 tokenId)`: Allows the owner of an NFT to transfer it.
    *   `isContractOwner()`: Returns `true` if `msg.sender` is the contract owner.
    *   `getPlayerPokemons(address player)`: Returns an array of token IDs owned by the specified `player`.
    *   `getListedPokemons()`: Returns arrays of token IDs and their prices for all Pokémon listed for fixed-price sale.
    *   `getAuctionPokemon()`: Returns detailed information about all active auctions.
    *   `listPokemonForSale(uint256 tokenId, uint256 price)`: Lists a Pokémon for sale at a fixed `price`.
    *   `cancelListing(uint256 tokenId)`: Allows the owner to cancel a fixed-price listing.
    *   `buyPokemon(uint256 tokenId)`: Allows a user to buy a Pokémon listed for fixed-price sale by sending `msg.value` equal to or greater than the price.
    *   `getListingPrice(uint256 tokenId)`: Returns the fixed-price listing price of a Pokémon.
    *   `startAuction(uint256 tokenId, uint256 startingPrice, uint256 duration)`: Starts an auction for a Pokémon. The NFT is transferred to the contract.
    *   `endAuction(uint256 tokenId)`: Ends an auction. Transfers NFT to the highest bidder (or back to seller if no bids) and funds to the seller.
    *   `placeBid(uint256 tokenId)`: Allows a user to place a bid in an ongoing auction. `msg.value` must be higher than the current highest bid or starting price.

---

### 5. Frontend (`frontend/`)

The frontend is a SvelteKit application that provides a user interface to interact with the `PokemonNFT` smart contract.

#### Core Files

*   **`svelte.config.js`:** SvelteKit configuration file, using `adapter-auto` and `vitePreprocess`.
*   **`vite.config.ts`:** Vite build tool configuration, includes the SvelteKit plugin and TailwindCSS Vite plugin.
*   **`src/app.html`:** The main HTML document shell for the SvelteKit application.
*   **`src/app.css`:** Global CSS file, primarily imports TailwindCSS base, components, and utilities.
*   **`src/app.d.ts`:** TypeScript declaration file for global types, notably extending the `Window` interface to include `ethereum` for MetaMask interaction.

#### Routes (`src/routes/`)

*   **`+layout.svelte`:** The main layout component for all pages. It imports global CSS and sets up `ToastContainer` for notifications.
*   **`+page.svelte`:** The main page of the application.
    *   **Functionality:**
        *   Connects to MetaMask wallet.
        *   Displays user's account and balance.
        *   If the connected user is the contract owner, provides an interface to mint new Pokémon.
        *   Displays Pokémon owned by the connected user ("My Pokémons").
            *   Allows listing owned Pokémon for fixed-price sale or starting an auction.
        *   Displays Pokémon available on the marketplace ("Marketplace").
            *   Shows Pokémon listed for fixed-price sale (allows buying).
            *   Shows Pokémon in active auctions (allows placing bids and ending auctions if applicable).
    *   **State Management:** Uses Svelte stores and local component state to manage UI and data.
    *   **Interaction:** Uses the `NFTHandler` class from `src/lib/nft.ts` to interact with the smart contract.

#### Library (`src/lib/`)

*   **`contracts-config.json`:**
    *   Contains the deployed `PokemonNFT` contract address (`nftAddress`) and its ABI (`nftAbi`).
    *   This file is automatically generated by the `scripts/deploy.js` script after contract deployment.
*   **`nft.ts`:**
    *   **`PokemonNFT` type:** Defines the TypeScript interface for Pokémon data used throughout the frontend, including details fetched from the contract and `pokemons.json`.
    *   **`NFTHandler` class:** A crucial class for encapsulating all interactions with the `PokemonNFT` smart contract.
        *   `constructor(provider)`: Initializes with an Ethers.js provider.
        *   `connectWallet()`: Handles connection to MetaMask, gets the signer, and initializes the contract instance.
        *   `checkIfOwner()`: Checks if the connected user is the owner of the smart contract.
        *   `mintPokemon(baseIdx, level)`: Calls the `mintPokemon` function on the contract.
        *   `fetchUserNFTs()`: Fetches and processes Pokémon owned by the current user.
        *   `fetchAllMarketNFTs()`: Fetches and processes all Pokémon listed on the marketplace (both fixed-price and auctions).
        *   `listNFT(tokenId, price)`: Lists an NFT for fixed-price sale.
        *   `buyNFT(tokenId, price)`: Buys an NFT.
        *   `startAuction(tokenId, startingPrice, durationMinutes)`: Starts an auction for an NFT.
        *   `placeBid(tokenId, bidAmount)`: Places a bid on an auction.
        *   `endAuction(tokenId)`: Ends an auction.
        *   `cancelListing(tokenId)`: Cancels a fixed-price listing.
*   **`pokemons.json`:**
    *   A JSON file containing an array of Pokémon objects. Each object includes:
        *   `national_number`, `english_name`, `description`, `primary_type`, `secondary_type`, `attack`, `defense`, etc.
    *   This data is used by the frontend to display Pokémon details and by the `deploy.js` script to determine `maxId`.

---

### 6. Scripts (`scripts/`)

#### `deploy.js`

A Hardhat script used to deploy the `PokemonNFT` smart contract.

*   **Functionality:**
    1.  Gets the deployer account from Hardhat.
    2.  Reads `frontend/src/lib/pokemons.json` to determine the `maxId` (number of unique Pokémon types) for the contract constructor.
    3.  Deploys the `PokemonNFT` contract using the determined `maxId`.
    4.  Waits for the deployment to be confirmed.
    5.  Writes the deployed contract's address and ABI to `frontend/src/lib/contracts-config.json`. This file is then used by the frontend to interact with the contract.
 
## Work Distribution
We were a group of 2.
Features Peer Rheinboldt:
   - Base starting point
   - Deployment scripts
   - Buy pokemon function
   - Testing
   - Safety

Features Patrik Dobcsanyi
   - Auction pokemon
   - Design updates
   - Pause function
   - Video

## Credits
- https://github.com/cristobalmitchell/pokedex for pokemon data

## AI Tools
- We have used ChatGPT and CoPilot for our project, mostly in frontend tasks and in helping to find bugs.
